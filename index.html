<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IDSS Školski portal</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg-color: #f7fafc;
      --primary-blue: #08ABE6;
      --primary-yellow: #FFCB29;
      --text-dark: #2d3748;
      --header-height: 80px;
      --marquee-height: 48px; 
    }
    html { scroll-behavior: smooth; }
    body {
      background-color: var(--bg-color);
      font-family: 'Roboto', sans-serif;
      color: var(--text-dark);
      padding-top: calc(var(--header-height) + var(--marquee-height));
    }
    .top-fixed-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .btn {
      transition: all 0.2s ease-in-out;
    }
    .btn-blue {
      background-color: var(--primary-blue);
      color: white;
    }
    .btn-blue:hover {
      background-color: #0798ce;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(8, 171, 230, 0.3);
    }
    .btn-yellow {
      background-color: var(--primary-yellow);
      color: var(--text-dark);
    }
    .btn-yellow:hover {
      background-color: #f0be26;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(255, 203, 41, 0.4);
    }
    .logo-glow {
        filter: drop-shadow(0 0 8px rgba(8, 171, 230, 0.5));
    }
    .marquee {
      width: 100%;
      overflow: hidden;
      background-color: #333;
      color: white;
      display: flex; 
      align-items: center; 
    }
    .marquee-content {
      display: inline-block;
      white-space: nowrap;
      padding-left: 100%;
      animation: marquee-scroll 90s linear infinite;
      font-size: 1.125rem;
    }
    @keyframes marquee-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .card-link {
        display: block;
        background-color: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .card-link:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(5px);
        display: none;
        z-index: 100;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .modal {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        display: none;
        z-index: 101;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal.active, .modal-overlay.active {
        display: block;
        opacity: 1;
    }
    .modal.active {
        transform: translate(-50%, -50%) scale(1);
    }
    .schedule-grid {
        display: grid;
        grid-template-columns: 100px repeat(5, 1fr);
        gap: 8px;
    }
    .schedule-header, .schedule-time, .schedule-card, .schedule-break {
        padding: 10px;
        text-align: center;
        border-radius: 6px;
    }
    .schedule-header {
        background-color: #e9ecef;
        font-weight: 700;
    }
    .schedule-time {
        background-color: #f8f9fa;
        font-weight: 500;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .schedule-card {
        color: white;
        font-size: 0.9em;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        min-height: 70px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 5px;
    }
    .schedule-card:hover, .schedule-card:focus {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10;
        outline: 2px solid var(--primary-blue);
    }
    .subject-mathe, .subject-mathematik { background-color: #ffc107; color: #333; }
    .subject-deutsch { background-color: #dc3545; }
    .subject-englisch { background-color: #8e44ad; } 
    .subject-bosnisch, .subject-bhs { background-color: #fd7e14; }
    .subject-sachkunde { background-color: #9acd32; color: #333; }
    .subject-gesellschaft { background-color: #27ae60; } 
    .subject-lebenskunde { background-color: #2ecc71; } 
    .subject-natur, .subject-naturkunde { background-color: #1abc9c; } 
    .subject-umweltkunde { background-color: #28a745; }
    .subject-kunst { background-color: #3498db; } 
    .subject-musik { background-color: #f06292; } 
    .subject-sport { background-color: #0dcaf0; color: #333;}
    .subject-ethik { background-color: #16a085; } 
    .subject-nacharbeit { background-color: #f5deb3; color: #333; }
    .subject-informatik { background-color: #6c757d; }
    .subject-geografie, .subject-erdkunde { background-color: #795548; }
    .subject-biologie { background-color: #20c997; }
    .subject-geschichte { background-color: #c0392b; } 
    .subject-physik { background-color: #008b8b; }
    .subject-chemie { background-color: #d35400; } 
    .subject-franzsisch { background-color: #3f51b5; }
    .subject-grundtechniken, .subject-technik { background-color: #4682b4; }
    .schedule-break {
        background-color: #e0e0e0;
        grid-column: 2 / -1;
        font-weight: 500;
        color: #555;
    }
    .trip-card {
        color: white;
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
        min-height: 130px;
    }
    .trip-card:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    .skeleton {
        background-color: #e2e8f0;
        border-radius: 0.25rem;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    @media print {
      body { padding-top: 0; }
      .top-fixed-container, #links-section, footer, .modal-overlay, .modal,
      #schedule-section > .bg-white > .flex, #calendar-section, #trips-section, #printBtn, #downloadBtn, #teachers-section {
        display: none;
      }
      main { padding-top: 0; }
      #schedule-to-print {
        position: static;
        width: auto;
        padding: 1em;
        box-shadow: none;
        border: none;
      }
      .schedule-card {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        border: 1px solid #ccc;
      }
      #schedule-container {
        overflow: visible !important;
      }
    }
  </style>
</head>
<body>

  <div class="top-fixed-container overflow-visible">
    <header class="bg-white/90 p-4 shadow-md" style="height: var(--header-height);">
      <div class="container mx-auto flex justify-between items-center h-full">
        <div class="flex items-center space-x-4">
          <img src="https://i.imgur.com/ZYxzQpd.png" alt="IDSS Logo" class="h-16 md:h-20 logo-glow">
          <h1 class="text-xl md:text-3xl font-bold text-gray-800" data-translate-key="pageTitle">IDSS Školski Portal</h1>
        </div>

        <nav class="hidden md:flex justify-center items-center h-full space-x-4">
            <a href="#schedule-section" class="group relative flex justify-center items-center w-12 h-12 rounded-full bg-gray-100 hover:bg-[var(--primary-blue)] text-gray-600 hover:text-white transition-all duration-300 shadow-sm hover:shadow-md">
                <i class="fas fa-calendar-days text-xl"></i>
                <span class="absolute bottom-full mb-2 w-max px-3 py-1.5 text-sm font-semibold text-white bg-gray-800 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity duration-300 pointer-events-none z-50" data-translate-key="navSchedule">Raspored Časova</span>
            </a>
            <a href="#teachers-section" class="group relative flex justify-center items-center w-12 h-12 rounded-full bg-gray-100 hover:bg-[var(--primary-blue)] text-gray-600 hover:text-white transition-all duration-300 shadow-sm hover:shadow-md">
                <i class="fas fa-users text-xl"></i>
                <span class="absolute bottom-full mb-2 w-max px-3 py-1.5 text-sm font-semibold text-white bg-gray-800 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity duration-300 pointer-events-none z-50" data-translate-key="navTeachers">Nastavnici</span>
            </a>
            <a href="#trips-section" class="group relative flex justify-center items-center w-12 h-12 rounded-full bg-gray-100 hover:bg-[var(--primary-blue)] text-gray-600 hover:text-white transition-all duration-300 shadow-sm hover:shadow-md">
                <i class="fas fa-map-signs text-xl"></i>
                <span class="absolute bottom-full mb-2 w-max px-3 py-1.5 text-sm font-semibold text-white bg-gray-800 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity duration-300 pointer-events-none z-50" data-translate-key="tripsTitle">Plan izleta i posjeta</span>
            </a>
            <a href="#calendar-section" class="group relative flex justify-center items-center w-12 h-12 rounded-full bg-gray-100 hover:bg-[var(--primary-blue)] text-gray-600 hover:text-white transition-all duration-300 shadow-sm hover:shadow-md">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="absolute bottom-full mb-2 w-max px-3 py-1.5 text-sm font-semibold text-white bg-gray-800 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity duration-300 pointer-events-none z-50" data-translate-key="navCalendar">Školski Kalendar</span>
            </a>
            <a href="#links-section" class="group relative flex justify-center items-center w-12 h-12 rounded-full bg-gray-100 hover:bg-[var(--primary-blue)] text-gray-600 hover:text-white transition-all duration-300 shadow-sm hover:shadow-md">
                <i class="fas fa-info-circle text-xl"></i>
                <span class="absolute bottom-full mb-2 w-max px-3 py-1.5 text-sm font-semibold text-white bg-gray-800 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-opacity duration-300 pointer-events-none z-50" data-translate-key="navInfo">Info</span>
            </a>
        </nav>
        
        <div class="flex items-center space-x-2">
          <select id="languageSelector" class="border rounded-md p-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#08ABE6]">
            <option value="bs">BS</option>
            <option value="en">EN</option>
            <option value="de">DE</option>
          </select>
          <button id="printBtn" title="Štampaj Raspored" class="btn btn-yellow p-2 rounded-lg font-semibold flex items-center">
            <i class="fas fa-print text-lg"></i>
          </button>
          <button id="downloadBtn" title="Preuzmi Raspored (PDF)" class="btn btn-blue p-2 rounded-lg font-semibold flex items-center">
            <i class="fas fa-file-pdf text-lg"></i>
          </button>
          <a id="downloadCalendarLink" href="https://drive.google.com/file/d/1DRaqBEDxQbZGmMtYphlcGXg63Rty83kK/view?usp=drive_link" target="_blank" rel="noopener noreferrer" title="Preuzmi Školski Kalendar (PDF)" class="btn btn-blue p-2 rounded-lg font-semibold flex items-center">
            <i class="fas fa-calendar-alt text-lg"></i>
          </a>
        </div>
      </div>
    </header>
    
    <div class="marquee" style="height: var(--marquee-height);">
      <p class="marquee-content" data-translate-key="marqueeText">
        Učitavanje obavijesti...
      </p>
    </div>
  </div>

  <main class="container mx-auto p-4 md:p-8">
    <section id="schedule-section" class="mb-12 pt-4">
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
          <h2 class="text-3xl font-bold text-gray-800" data-translate-key="scheduleTitle">Raspored Časova</h2>
          <div class="flex items-center space-x-3">
            <label for="gradeSelector" class="font-semibold" data-translate-key="selectGrade">Odaberite razred:</label>
            <select id="gradeSelector" class="border rounded-md p-2 font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#08ABE6]">
              <option value="1">1. Razred</option><option value="2">2. Razred</option><option value="3">3. Razred</option><option value="4">4. Razred</option><option value="5">5. Razred</option><option value="6">6. Razred</option><option value="7">7. Razred</option><option value="8">8. Razred</option><option value="9">9. Razred</option>
            </select>
          </div>
        </div>
        <div id="schedule-to-print">
            <h3 id="schedule-print-header" class="text-xl font-bold text-center mb-4 text-gray-700"></h3>
            <div id="schedule-container" class="overflow-x-auto">
                <div class="schedule-grid">
                    <div class="schedule-header"></div><div class="schedule-header skeleton h-6"></div><div class="schedule-header skeleton h-6"></div><div class="schedule-header skeleton h-6"></div><div class="schedule-header skeleton h-6"></div><div class="schedule-header skeleton h-6"></div>
                    <div class="schedule-time skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div>
                    <div class="schedule-time skeleton h-6"></div><div class="schedule-break skeleton h-6"></div>
                    <div class="schedule-time skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div>
                    <div class="schedule-time skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div><div class="skeleton h-16"></div>
                </div>
            </div>
        </div>
      </div>
    </section>

    <section id="teachers-section" class="mb-12 pt-4">
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-3xl font-bold text-gray-800" data-translate-key="teachersTitle">Nastavnici</h2>
            <div class="w-full md:w-1/2 lg:w-1/3 relative">
              <input type="search" id="teacherSearch" class="w-full border rounded-md p-2 pl-10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#08ABE6]" placeholder="Pretraži...">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
          </div>
          <div id="teachers-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Skeleton Loader -->
            <div class="h-48 skeleton rounded-lg"></div><div class="h-48 skeleton rounded-lg"></div><div class="h-48 skeleton rounded-lg"></div><div class="h-48 skeleton rounded-lg"></div>
            <div class="h-48 skeleton rounded-lg"></div><div class="h-48 skeleton rounded-lg"></div><div class="h-48 skeleton rounded-lg"></div><div class="h-48 skeleton rounded-lg"></div>
          </div>
        </div>
    </section>

    <section id="links-section" class="pt-4 mb-12">
      <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center" data-translate-key="infoLinks">Informativni Linkovi</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <a href="https://drive.google.com/file/d/1-5nv_nPy3hJDKyox8ipRLdLnLFR-LTvu/view?usp=drive_link" target="_blank" rel="noopener noreferrer" class="card-link">
            <div class="flex items-center space-x-4"><i class="fas fa-comments text-3xl text-[#08ABE6]"></i><div><h3 class="text-xl font-bold" data-translate-key="consultationsTitle">Konsultacije</h3><p class="text-gray-600" data-translate-key="consultationsDesc">Raspored konsultacija za nastavnike</p></div></div>
        </a>
        <a href="#trips-section" class="card-link">
            <div class="flex items-center space-x-4"><i class="fas fa-map-signs text-3xl text-[#08ABE6]"></i><div><h3 class="text-xl font-bold" data-translate-key="tripsTitle">Plan izleta i posjeta</h3><p class="text-gray-600" data-translate-key="tripsDesc">Pogledajte planirane izlete</p></div></div>
        </a>
        <a href="#" class="card-link opacity-50 cursor-not-allowed">
            <div class="flex items-center space-x-4"><i class="fas fa-file-alt text-3xl text-gray-400"></i><div><h3 class="text-xl font-bold" data-translate-key="testsTitle">Pismene provjere</h3><p class="text-gray-600" data-translate-key="testsDesc">Uskoro dostupno</p></div></div>
        </a>
        <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=KnsJlDOpkEeyDyfuedX7SBHJH65v9sdGhj0OvjQUhp9UQjVFR01FRUVROTFVVjdZUlUyR1FLVVhSVC4u" target="_blank" rel="noopener noreferrer" class="card-link">
            <div class="flex items-center space-x-4"><i class="fas fa-address-card text-3xl text-[#08ABE6]"></i><div><h3 class="text-xl font-bold" data-translate-key="booksTitle">Promjena kontakta</h3><p class="text-gray-600" data-translate-key="booksDesc">Ažurirajte vaše kontakt informacije</p></div></div>
        </a>
        <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=KnsJlDOpkEeyDyfuedX7SBHJH65v9sdGhj0OvjQUhp9UOElUQkk1VUVYSzZKUENFQTZaNlAwTVcxVS4u" target="_blank" rel="noopener noreferrer" class="card-link">
            <div class="flex items-center space-x-4"><i class="fas fa-bus text-3xl text-[#08ABE6]"></i><div><h3 class="text-xl font-bold" data-translate-key="transportTitle">Prijevoz</h3><p class="text-gray-600" data-translate-key="transportDesc">Prijava za školski prijevoz</p></div></div>
        </a>
        <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=KnsJlDOpkEeyDyfuedX7SBHJH65v9sdGhj0OvjQUhp9UN0dRSkhTRFJLQlUzWDZHTE00VDdRWENaNi4u" target="_blank" rel="noopener noreferrer" class="card-link">
            <div class="flex items-center space-x-4"><i class="fas fa-utensils text-3xl text-[#08ABE6]"></i><div><h3 class="text-xl font-bold" data-translate-key="foodTitle">Doručak</h3><p class="text-gray-600" data-translate-key="foodDesc">Prijava za školski doručak</p></div></div>
        </a>
      </div>
    </section>
    
    <section id="trips-section" class="mb-12 pt-4 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg">
             <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-gray-800" data-translate-key="tripsSectionTitle">Plan Izleta i Posjeta</h2>
                <div class="flex items-center space-x-3">
                    <label for="tripsGradeSelector" class="font-semibold" data-translate-key="selectGrade">Odaberite razred:</label>
                    <select id="tripsGradeSelector" class="border rounded-md p-2 font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#08ABE6]">
                    </select>
                </div>
            </div>
            <div id="trips-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Skeleton Loader -->
                <div class="h-32 skeleton rounded-lg"></div>
                <div class="h-32 skeleton rounded-lg"></div>
                <div class="h-32 skeleton rounded-lg"></div>
                <div class="h-32 skeleton rounded-lg"></div>
            </div>
        </div>
    </section>

    <section id="calendar-section" class="mb-12 pt-4 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6" data-translate-key="schoolCalendarTitle">Školski Kalendar 2025/2026</h2>
            <div id="calendar-container" class="space-y-8">
                <div class="mb-4">
                    <div class="h-8 w-48 mb-4 skeleton"></div>
                    <div class="space-y-3">
                        <div class="flex items-center p-3 h-16 skeleton"></div>
                        <div class="flex items-center p-3 h-16 skeleton"></div>
                    </div>
                </div>
                 <div class="mb-4">
                    <div class="h-8 w-48 mb-4 skeleton"></div>
                    <div class="space-y-3">
                        <div class="flex items-center p-3 h-16 skeleton"></div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-600">
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-200 border border-red-300 mr-2"></span><span data-translate-key="legendNonWorking">Neradni dani</span></div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-200 border border-yellow-300 mr-2"></span><span data-translate-key="legendEvents">Događaji</span></div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-200 border border-blue-300 mr-2"></span><span data-translate-key="legendHolidays">Raspusti</span></div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-200 border border-green-300 mr-2"></span><span data-translate-key="legendNonTeaching">Nenastavni dani</span></div>
            </div>
        </div>
    </section>

  </main>
  
  <footer class="bg-gray-800 text-white mt-12 py-8">
    <div class="container mx-auto px-4 text-center">
        <p>&copy; 2025 IDSS Školski Portal. Sva prava zadržana.</p>
    </div>
  </footer>

  <div id="teacher-modal-overlay" class="modal-overlay"></div>
  <div id="teacher-modal" class="modal w-11/12 max-w-md">
    <button id="modal-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    <div id="modal-content" class="text-center"></div>
  </div>

  <div id="trip-modal-overlay" class="modal-overlay"></div>
  <div id="trip-modal" class="modal w-11/12 max-w-2xl">
      <button id="trip-modal-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <div id="trip-modal-content"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- SPREADSHEET CONFIG ---
    // Direct "Publish to Web" links are used as they are served with the correct CORS headers by Google.
    const scheduleSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRW_XW4OPVNRbcxqYlpNc7o0T8G56KnchdWDvev-Dx1K66qRVLDdq36YwYl0xmBoQtsDuBX7-CM3Ep7/pub?gid=1801105242&single=true&output=csv";
    const teachersSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRW_XW4OPVNRbcxqYlpNc7o0T8G56KnchdWDvev-Dx1K66qRVLDdq36YwYl0xmBoQtsDuBX7-CM3Ep7/pub?gid=2003751727&single=true&output=csv";
    const tripsSheetUrl    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRW_XW4OPVNRbcxqYlpNc7o0T8G56KnchdWDvev-Dx1K66qRVLDdq36YwYl0xmBoQtsDuBX7-CM3Ep7/pub?gid=97311438&single=true&output=csv";
    const calendarSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRW_XW4OPVNRbcxqYlpNc7o0T8G56KnchdWDvev-Dx1K66qRVLDdq36YwYl0xmBoQtsDuBX7-CM3Ep7/pub?gid=0&single=true&output=csv";
    const marqueeSheetUrl  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRW_XW4OPVNRbcxqYlpNc7o0T8G56KnchdWDvev-Dx1K66qRVLDdq36YwYl0xmBoQtsDuBX7-CM3Ep7/pub?gid=396090986&single=true&output=csv";
    
    const translations = {
        bs: {
            pageTitle: "IDSS Školski Portal",
            navSchedule: "Raspored Časova",
            navTeachers: "Nastavnici",
            navCalendar: "Školski Kalendar",
            navInfo: "Info",
            marqueeText: "Dobrodošli na informativni portal Međunarodne njemačke škole Sarajevo (IDSS). Ovdje možete pronaći raspored časova, školski kalendar i druge važne informacije. || Welcome to the information portal of the International German School Sarajevo (IDSS). Here you can find the class schedule, school calendar, and other important information. || Willkommen auf dem Informationsportal der Internationalen Deutschen Schule Sarajevo (IDSS). Hier finden Sie den Stundenplan, den Schulkalender und weitere wichtige Informationen.",
            scheduleTitle: "Raspored Časova",
            selectGrade: "Odaberite razred:",
            teachersTitle: "Nastavnici",
            teacherSearchPlaceholder: "Pretraži po imenu ili predmetu...",
            noTeachersFound: "Nema rezultata za Vašu pretragu.",
            consultationsTitle: "Konsultacije",
            consultationsDesc: "Raspored konsultacija za nastavnike",
            testsTitle: "Pismene provjere",
            testsDesc: "Uskoro dostupno",
            booksTitle: "Promjena Kontakta",
            booksDesc: "Ažurirajte vaše kontakt informacije",
            transportTitle: "Prijevoz",
            transportDesc: "Prijava za školski prijevoz",
            foodTitle: "Doručak",
            foodDesc: "Prijava za školski doručak",
            infoLinks: "Informativni Linkovi",
            schoolCalendarTitle: "Školski Kalendar 2025/2026",
            legendNonWorking: "Neradni dani",
            legendEvents: "Događaji",
            legendHolidays: "Raspusti",
            legendNonTeaching: "Nenastavni dani",
            grade: "Razred",
            subject: "Predmet",
            teacher: "Nastavnik",
            room: "Učionica",
            printBtnTitle: "Štampaj Raspored",
            downloadBtnTitle: "Preuzmi Raspored (PDF)",
            calendarBtnTitle: "Preuzmi Školski Kalendar (PDF)",
            days: ['Ponedjeljak', 'Utorak', 'Srijeda', 'Četvrtak', 'Petak'],
            tripsTitle: "Plan izleta i posjeta",
            tripsDesc: "Pogledajte planirane izlete",
            tripsSectionTitle: "Plan Izleta i Posjeta",
            noTripsFound: "Nema planiranih izleta za ovaj razred.",
            noTripsAvailable: "Nema dostupnih izleta.",
            tripModal: {
                destination: "Mjesto Posjete",
                goal: "Osnovni Cilj / Tip Aktivnosti",
                plan: "Plan Realizacije (Okvirna satnica)",
                pedagogy: "Detaljni Pedagoški Ciljevi",
                notes: "Specifične Napomene i Resursi",
                contact: "Odgovorne Osobe / Podrška"
            },
            subjects: "Predmeti",
            consultation: "Konsultacije"
        },
        en: {
            pageTitle: "IDSS School Portal",
            navSchedule: "Class Schedule",
            navTeachers: "Teachers",
            navCalendar: "School Calendar",
            navInfo: "Info",
            marqueeText: "Welcome to the information portal of the International German School Sarajevo (IDSS). Here you can find the class schedule, school calendar, and other important information. || Willkommen auf dem Informationsportal der Internationalen Deutschen Schule Sarajevo (IDSS). Hier finden Sie den Stundenplan, den Schulkalender und weitere wichtige Informationen. || Dobrodošli na informativni portal Međunarodne njemačke škole Sarajevo (IDSS). Ovdje možete pronaći raspored časova, školski kalendar i druge važne informacije.",
            scheduleTitle: "Class Schedule",
            selectGrade: "Select grade:",
            teachersTitle: "Teachers",
            teacherSearchPlaceholder: "Search by name or subject...",
            noTeachersFound: "No results for your search.",
            consultationsTitle: "Consultations",
            consultationsDesc: "Teacher consultation schedule",
            testsTitle: "Written tests",
            testsDesc: "Coming soon",
            booksTitle: "Contact Change",
            booksDesc: "Update your contact information",
            transportTitle: "Transportation",
            transportDesc: "Application for school transport",
            foodTitle: "Breakfast",
            foodDesc: "Application for school breakfast",
            infoLinks: "Information Links",
            schoolCalendarTitle: "School Calendar 2025/2026",
            legendNonWorking: "Non-working days",
            legendEvents: "Events",
            legendHolidays: "Holidays",
            legendNonTeaching: "Non-teaching days",
            grade: "Grade",
            subject: "Subject",
            teacher: "Teacher",
            room: "Room",
            printBtnTitle: "Print Schedule",
            downloadBtnTitle: "Download Schedule (PDF)",
            calendarBtnTitle: "Download School Calendar (PDF)",
            days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'],
            tripsTitle: "Trips and Visits Plan",
            tripsDesc: "See the planned trips",
            tripsSectionTitle: "Trips and Visits Plan",
            noTripsFound: "No trips planned for this grade.",
            noTripsAvailable: "No trips available.",
            tripModal: {
                destination: "Destination",
                goal: "Main Goal / Activity Type",
                plan: "Realization Plan (Approx. timeline)",
                pedagogy: "Detailed Pedagogical Goals",
                notes: "Specific Notes and Resources",
                contact: "Responsible Persons / Support"
            },
            subjects: "Subjects",
            consultation: "Consultation"
        },
        de: {
            pageTitle: "IDSS Schulportal",
            navSchedule: "Stundenplan",
            navTeachers: "Lehrer",
            navCalendar: "Schulkalender",
            navInfo: "Info",
            marqueeText: "Willkommen auf dem Informationsportal der Internationalen Deutschen Schule Sarajevo (IDSS). Hier finden Sie den Stundenplan, den Schulkalender und weitere wichtige Informationen. || Welcome to the information portal of the International German School Sarajevo (IDSS). Here you can find the class schedule, school calendar, and other important information. || Dobrodošli na informativni portal Međunarodne njemačke škole Sarajevo (IDSS). Ovdje možete pronaći raspored časova, školski kalendar i druge važne informacije.",
            scheduleTitle: "Stundenplan",
            selectGrade: "Klasse wählen:",
            teachersTitle: "Lehrer",
            teacherSearchPlaceholder: "Suche nach Name oder Fach...",
            noTeachersFound: "Keine Ergebnisse für Ihre Suche gefunden.",
            consultationsTitle: "Sprechstunden",
            consultationsDesc: "Sprechstundenplan der Lehrer",
            testsTitle: "Schriftliche Tests",
            testsDesc: "Demnächst verfügbar",
            booksTitle: "Kontaktänderung",
            booksDesc: "Aktualisieren Sie Ihre Kontaktinformationen",
            transportTitle: "Transport",
            transportDesc: "Anmeldung für den Schultransport",
            foodTitle: "Frühstück",
            foodDesc: "Anmeldung für das Schulfrühstück",
            infoLinks: "Informationslinks",
            schoolCalendarTitle: "Schulkalender 2025/2026",
            legendNonWorking: "Arbeitsfreie Tage",
            legendEvents: "Veranstaltungen",
            legendHolidays: "Ferien",
            legendNonTeaching: "Unterrichtsfreie Tage",
            grade: "Klasse",
            subject: "Fach",
            teacher: "Lehrer",
            room: "Raum",
            printBtnTitle: "Stundenplan drucken",
            downloadBtnTitle: "Stundenplan herunterladen (PDF)",
            calendarBtnTitle: "Schulkalender herunterladen (PDF)",
            days: ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'],
            tripsTitle: "Ausflugs- und Besuchsplan",
            tripsDesc: "Siehe die geplanten Ausflüge",
            tripsSectionTitle: "Ausflugs- und Besuchsplan",
            noTripsFound: "Für diese Klasse sind keine Ausflüge geplant.",
            noTripsAvailable: "Keine Ausflüge verfügbar.",
            tripModal: {
                destination: "Besuchsort",
                goal: "Hauptziel / Aktivitätstyp",
                plan: "Realisierungsplan (Ungefährer Zeitplan)",
                pedagogy: "Detaillierte pädagogische Ziele",
                notes: "Spezifische Hinweise und Ressourcen",
                contact: "Verantwortliche Personen / Unterstützung"
            },
            subjects: "Fächer",
            consultation: "Sprechstunde"
        }
    };

    const langLocales = { bs: 'bs-BA', en: 'en-US', de: 'de-DE' };
    const languageSelector = document.getElementById('languageSelector');
    let currentLang = localStorage.getItem('language') || 'bs';
    
    const dayAbbreviationMap = {
        'mon': 'Ponedjeljak', 'tue': 'Utorak', 'wed': 'Srijeda', 
        'thu': 'Četvrtak', 'fri': 'Petak'
    };
    const calendarTypeMap = {
        'non-teaching': 'nenastavni', 'event': 'događaj',
        'holiday': 'raspust', 'non-working': 'neradni'
    };
    
    let allTeachersData = [];
    let teachersDataPromise = null;

    function getInitials(name) {
        if (!name) return '?';
        const parts = name.split(' ').filter(Boolean);
        if (parts.length === 1) {
            return parts[0].substring(0, 2).toUpperCase();
        }
        return (parts[0][0] + (parts[parts.length - 1][0] || '')).toUpperCase();
    }

    function stringToColor(str) {
        if (!str) return '#cccccc';
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
            hash = hash & hash; // Convert to 32bit integer
        }
        const hue = hash % 360;
        return `hsl(${hue}, 60%, 50%)`;
    }

    function normalizeString(str) {
        if (!str) return '';
        return str
            .toLowerCase()
            .trim()
            .normalize("NFD") // Decompose to base char + diacritic
            .replace(/[\u0300-\u036f]/g, "") // Remove diacritics
            .replace(/đ/g, 'd') // Handle special case for 'đ'
            .replace(/\s+/g, ' '); // Collapse multiple whitespaces
    }

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('language', lang);
        languageSelector.value = lang;
        document.documentElement.lang = lang;

        document.querySelectorAll('[data-translate-key]').forEach(element => {
            const key = element.getAttribute('data-translate-key');
            const translation = translations[lang]?.[key] ?? translations['bs'][key];
            if (translation) {
                element.innerHTML = translation;
            }
        });
        
        document.getElementById('printBtn').title = translations[lang].printBtnTitle;
        document.getElementById('downloadBtn').title = translations[lang].downloadBtnTitle;
        document.getElementById('teacherSearch').placeholder = translations[lang].teacherSearchPlaceholder;
        const calendarLink = document.getElementById('downloadCalendarLink');
        if (calendarLink) {
            calendarLink.title = translations[lang].calendarBtnTitle;
        }

        fetchAndDisplaySchedule();
        fetchAndDisplayTeachers();
        fetchAndDisplayCalendar();
        fetchAndDisplayTrips();
        fetchMarqueeText();
    }
    
    languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));

    const gradeSelector = document.getElementById('gradeSelector');
    gradeSelector.addEventListener('change', fetchAndDisplaySchedule);

    function validateData(data, requiredFields, sectionName) {
        if (!data || data.length === 0) {
            throw new Error(`Nema podataka za "${sectionName}". Tabela je možda prazna ili neispravno formatirana.`);
        }
        const headers = Object.keys(data[0]); // Headers are already lowercased by parseCSV
        for (const field of requiredFields) {
            if (!headers.includes(field)) {
                const errorMsg = `Podaci za "${sectionName}" su neispravni. Nedostaje obavezna kolona: "${field}". Dostupne kolone su: [${headers.join(', ')}]. Molimo provjerite Google Sheet.`;
                console.error(errorMsg);
                throw new Error(errorMsg);
            }
        }
        return true;
    }
    
    function parseCSV(text) {
        const lines = text.trim().replace(/\r\n/g, '\n').split('\n');
        if (lines.length < 2) return [];

        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        const data = [];

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if (line.trim() === '') continue;

            const row = [];
            let field = '';
            let inQuotes = false;

            for (let j = 0; j < line.length; j++) {
                const char = line[j];

                if (char === '"' && j + 1 < line.length && line[j + 1] === '"') {
                    field += '"';
                    j++; 
                } else if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    row.push(field.trim());
                    field = '';
                } else {
                    field += char;
                }
            }
            row.push(field.trim()); 

            if (row.length > 0 && row.some(cell => cell !== '')) {
                const obj = {};
                for (let k = 0; k < headers.length; k++) {
                    obj[headers[k]] = row[k] || '';
                }
                data.push(obj);
            }
        }
        return data;
    }

    function getTeachersData() {
        if (!teachersDataPromise) {
            teachersDataPromise = fetch(teachersSheetUrl, { cache: 'no-cache' })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(text => {
                    const data = parseCSV(text);
                    validateData(data, ['name', 'email', 'subjects'], 'Nastavnici');
                    return data;
                });
        }
        return teachersDataPromise;
    }

    async function fetchAndDisplaySchedule() {
        const grade = gradeSelector.value;
        const lang = currentLang;
        const scheduleContainer = document.getElementById('schedule-container');

        try {
            const [scheduleResponse, teachersData] = await Promise.all([
                fetch(scheduleSheetUrl, { cache: 'no-cache' }),
                getTeachersData()
            ]);

            if (!scheduleResponse.ok) {
                throw new Error('Network response was not ok');
            }

            const scheduleText = await scheduleResponse.text();
            
            const scheduleData = parseCSV(scheduleText);
            
            validateData(scheduleData, ['razred', 'vrijeme', 'dan', 'predmet'], 'Raspored');

            const gradeSchedule = scheduleData.filter(item => item.razred === grade);
            
            const timeSlots = [...new Set(gradeSchedule.map(item => item.vrijeme))].sort((a, b) => {
                const extractTime = (timeStr) => {
                    if (!timeStr) return null;
                    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
                    if (!match) return null;
                    return { hours: parseInt(match[1], 10), minutes: parseInt(match[2], 10) };
                };

                const timeA = extractTime(a);
                const timeB = extractTime(b);

                if (!timeA && !timeB) return a.localeCompare(b);
                if (!timeA) return 1;
                if (!timeB) return -1;

                if (timeA.hours !== timeB.hours) {
                    return timeA.hours - timeB.hours;
                }
                return timeA.minutes - timeB.minutes;
            });
            
            let html = '<div class="schedule-grid">';
            html += `<div class="schedule-header"></div>`;
            translations[lang].days.forEach(day => {
                html += `<div class="schedule-header">${day}</div>`;
            });

            timeSlots.forEach(slot => {
                const entriesForSlot = gradeSchedule.filter(item => item.vrijeme === slot);
                const breakEntry = entriesForSlot.find(item => (item.dan || '').toLowerCase() === 'pauza');

                if (breakEntry) {
                    html += `<div class="schedule-time">${slot}</div>`;
                    html += `<div class="schedule-break">${breakEntry.predmet || ''}</div>`;
                } else {
                    html += `<div class="schedule-time">${slot}</div>`;
                    translations[lang].days.forEach((dayKey, dayIndex) => {
                        const dayBosnian = translations['bs'].days[dayIndex];
                        const entry = entriesForSlot.find(item => {
                            const itemDayAbbr = (item.dan || '').toLowerCase();
                            const mappedDayBosnian = dayAbbreviationMap[itemDayAbbr];
                            return mappedDayBosnian === dayBosnian;
                        });

                        if (entry) {
                            const teacherName = entry.nastavnik || '';
                            const subjectClass = 'subject-' + ((entry.predmet || '').toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''));
                            html += `<div class="schedule-card ${subjectClass}" tabindex="0" data-teacher-name="${teacherName}">
                                <span class="font-bold">${entry.predmet || ''}</span>
                                <span class="text-xs">${teacherName}</span>
                                <span class="text-xs font-light">${entry.učionica || ''}</span>
                            </div>`;
                        } else {
                            html += `<div></div>`;
                        }
                    });
                }
            });

            html += '</div>';
            scheduleContainer.innerHTML = html;
            
            const selectedGradeText = gradeSelector.options[gradeSelector.selectedIndex].text;
            document.getElementById('schedule-print-header').textContent = `${translations[lang].scheduleTitle} - ${selectedGradeText}`;

            setupTeacherModalListeners('.schedule-card', teachersData);

        } catch (error) {
            console.error('Error fetching or parsing schedule data:', error);
            scheduleContainer.innerHTML = `<div class="text-red-500 text-center col-span-6 p-4 border border-red-200 rounded-md bg-red-50"><strong>Greška pri učitavanju rasporeda.</strong><p class="text-sm mt-2">${error.message}</p></div>`;
        }
    }

    function setupTeacherModalListeners(selector, teachersData) {
        const modal = document.getElementById('teacher-modal');
        const overlay = document.getElementById('teacher-modal-overlay');
        const modalContent = document.getElementById('modal-content');

        document.querySelectorAll(selector).forEach(card => {
            card.addEventListener('click', () => {
                const teacherName = (card.getAttribute('data-teacher-name') || '');
                if (!teacherName) return;

                const normalizedName = normalizeString(teacherName);
                const teacher = teachersData.find(t => normalizeString(t.name) === normalizedName);

                if (teacher) {
                    const initials = getInitials(teacher.name);
                    const bgColor = stringToColor(teacher.name);
                    modalContent.innerHTML = `
                        <div class="flex flex-col items-center text-center">
                            <div class="w-24 h-24 rounded-full flex items-center justify-center mb-4 text-white text-4xl font-bold" style="background-color: ${bgColor};">
                                ${initials}
                            </div>
                            <h3 class="text-2xl font-bold mb-2">${teacher.name}</h3>
                            <a href="mailto:${teacher.email}" class="text-[var(--primary-blue)] hover:underline mb-4">${teacher.email}</a>
                            <div class="text-left w-full mt-4 border-t pt-4">
                                <p class="mb-2">
                                    <strong class="font-semibold text-gray-700">${translations[currentLang].subjects}:</strong> 
                                    <span class="text-gray-600">${teacher.subjects || ''}</span>
                                </p>
                                <p>
                                    <strong class="font-semibold text-gray-700">${translations[currentLang].consultation}:</strong> 
                                    <span class="text-gray-600">${teacher.consultation_day || ''} ${teacher.consultation_time || ''}</span>
                                </p>
                            </div>
                        </div>
                    `;
                    modal.classList.add('active');
                    overlay.classList.add('active');
                }
            });
        });
    }

    function renderTeachers(teachers) {
        const container = document.getElementById('teachers-container');
        const lang = currentLang;

        if (teachers.length === 0) {
            container.innerHTML = `<div class="col-span-full text-center py-8 text-gray-500">${translations[lang].noTeachersFound}</div>`;
            return;
        }

        container.innerHTML = teachers.map(teacher => {
            const initials = getInitials(teacher.name);
            const bgColor = stringToColor(teacher.name);
            return `
                <div class="teacher-card p-4 bg-white border rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer flex flex-col items-center text-center" data-teacher-name="${teacher.name}" tabindex="0">
                    <div class="w-20 h-20 rounded-full flex items-center justify-center mb-3 text-white text-3xl font-bold" style="background-color: ${bgColor};">
                        ${initials}
                    </div>
                    <h4 class="font-bold text-lg text-gray-800">${teacher.name}</h4>
                    <a href="mailto:${teacher.email}" class="text-sm text-[var(--primary-blue)] hover:underline break-all">${teacher.email}</a>
                    <p class="text-xs text-gray-500 mt-2 flex-grow">${(teacher.subjects || '').split(',').join(', ')}</p>
                </div>
            `;
        }).join('');

        setupTeacherModalListeners('#teachers-container .teacher-card', allTeachersData);
    }

    function setupTeacherSearch() {
        const searchInput = document.getElementById('teacherSearch');
        searchInput.addEventListener('input', (e) => {
            const searchTerm = normalizeString(e.target.value);
            if (!searchTerm) {
                renderTeachers(allTeachersData);
                return;
            }
            const filteredTeachers = allTeachersData.filter(teacher => 
                normalizeString(teacher.name).includes(searchTerm) || 
                normalizeString(teacher.subjects).includes(searchTerm)
            );
            renderTeachers(filteredTeachers);
        });
    }
    
    async function fetchAndDisplayTeachers() {
        const container = document.getElementById('teachers-container');
        try {
            const teachersData = await getTeachersData();
            allTeachersData = teachersData;
            renderTeachers(allTeachersData);
        } catch (error) {
            console.error('Error fetching teachers data:', error);
            container.innerHTML = `<div class="text-red-500 text-center col-span-full p-4 border border-red-200 rounded-md bg-red-50"><strong>Greška pri učitavanju nastavnika.</strong><p class="text-sm mt-2">${error.message}</p></div>`;
        }
    }


    // --- TRIPS SECTION LOGIC ---
    let allTripsData = [];
    const tripsGradeSelector = document.getElementById('tripsGradeSelector');

    function displayFilteredTrips() {
        const selectedGrade = tripsGradeSelector.value;
        const container = document.getElementById('trips-container');
        
        const filteredTrips = allTripsData.filter(trip => trip.razred === selectedGrade);

        if (filteredTrips.length === 0) {
            container.innerHTML = `<div class="col-span-full text-center py-8 text-gray-500" data-translate-key="noTripsFound">${translations[currentLang].noTripsFound}</div>`;
            return;
        }

        container.innerHTML = filteredTrips.map(trip => {
            const bgColor = stringToColor(trip['mjesto posjete'] || trip.id);
            return `
                <div class="trip-card" data-trip-id="${trip.id}" style="background-color: ${bgColor};">
                    <h4 class="font-bold text-lg">${trip['mjesto posjete']}</h4>
                    <p class="text-sm opacity-90">${trip['planirani datum']}</p>
                </div>
            `;
        }).join('');
        
        setupTripModal(allTripsData);
    }

    tripsGradeSelector.addEventListener('change', displayFilteredTrips);
    
    async function fetchAndDisplayTrips() {
        const container = document.getElementById('trips-container');
        try {
            const response = await fetch(tripsSheetUrl, { cache: 'no-cache' });
            if (!response.ok) throw new Error(`Network response was not ok for ${tripsSheetUrl}`);
            const text = await response.text();
            allTripsData = parseCSV(text);
            validateData(allTripsData, ['id', 'razred', 'planirani datum', 'mjesto posjete'], 'Izleti');
            
            const uniqueGrades = [...new Set(allTripsData.map(trip => trip.razred))].sort((a, b) => {
                const isPreschoolA = a.toLowerCase().includes('preschool');
                const isPreschoolB = b.toLowerCase().includes('preschool');
                if (isPreschoolA && !isPreschoolB) return -1;
                if (!isPreschoolA && isPreschoolB) return 1;
                const numA = parseInt(a);
                const numB = parseInt(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            
            const currentSelection = tripsGradeSelector.value;
            tripsGradeSelector.innerHTML = uniqueGrades.map(grade => `<option value="${grade}">${grade}</option>`).join('');
            
            if (uniqueGrades.includes(currentSelection)) {
                tripsGradeSelector.value = currentSelection;
            }

            if (uniqueGrades.length > 0) {
                displayFilteredTrips();
            } else {
                container.innerHTML = `<div class="col-span-full text-center py-8 text-gray-500" data-translate-key="noTripsAvailable">${translations[currentLang].noTripsAvailable}</div>`;
            }
            
        } catch (error) {
            console.error('Error fetching data from Google Sheets:', error);
            container.innerHTML = `<div class="text-red-500 p-4 border border-red-200 rounded-md bg-red-50 col-span-full"><strong>Greška pri učitavanju plana izleta.</strong><p class="text-sm mt-2">${error.message}</p></div>`;
        }
    }

    function setupTripModal(tripsData) {
        const modal = document.getElementById('trip-modal');
        const overlay = document.getElementById('trip-modal-overlay');
        const closeBtn = document.getElementById('trip-modal-close');
        const modalContent = document.getElementById('trip-modal-content');

        document.querySelectorAll('.trip-card').forEach(card => {
            card.addEventListener('click', () => {
                const tripId = card.dataset.tripId;
                const trip = tripsData.find(t => t.id === tripId);
                if (trip) {
                    const lang = currentLang;
                    const modalKeys = translations[lang].tripModal;
                    modalContent.innerHTML = `
                        <h3 class="text-2xl font-bold mb-4 text-center text-[var(--primary-blue)]">${trip['mjesto posjete']}</h3>
                        <p class="text-center text-gray-500 mb-6 font-semibold">${trip['planirani datum']}</p>
                        <div class="space-y-4 text-left">
                            ${createDetailRow(modalKeys.goal, trip['osnovni cilj / tip aktivnosti'])}
                            ${createDetailRow(modalKeys.plan, trip['plan realizacije (okvirna satnica)'])}
                            ${createDetailRow(modalKeys.pedagogy, trip['detaljni pedagoški ciljevi aktivnosti'])}
                            ${createDetailRow(modalKeys.notes, trip['specifične napomene i resursi'])}
                            ${createDetailRow(modalKeys.contact, trip['odgovorne osobe / podrška'])}
                        </div>
                    `;
                    modal.classList.add('active');
                    overlay.classList.add('active');
                }
            });
        });
        
        function createDetailRow(title, content) {
            if (!content || content.trim() === '') return '';
            return `
                <div>
                    <h4 class="font-bold text-lg text-gray-700">${title}</h4>
                    <p class="text-gray-600 whitespace-pre-wrap">${content}</p>
                </div>`;
        }

        const closeModal = () => {
            modal.classList.remove('active');
            overlay.classList.remove('active');
        };

        closeBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', closeModal);
    }
    
    async function fetchAndDisplayCalendar() {
        const container = document.getElementById('calendar-container');
        try {
            const response = await fetch(calendarSheetUrl, { cache: 'no-cache' });
            if (!response.ok) throw new Error('Network error');
            const text = await response.text();
            const data = parseCSV(text);
            validateData(data, ['date', 'type', 'title_bs', 'title_en', 'title_de'], 'Kalendar');

            const eventsByMonth = data.reduce((acc, event) => {
                const date = new Date(event.date);
                if (isNaN(date.getTime())) {
                    console.warn(`Invalid date format for calendar event: "${event.date}"`);
                    return acc;
                }
                const monthYear = date.toLocaleString(langLocales[currentLang], { month: 'long', year: 'numeric' });
                if (!acc[monthYear]) acc[monthYear] = [];
                acc[monthYear].push(event);
                return acc;
            }, {});

            const monthOrder = Object.keys(eventsByMonth).sort((a, b) => {
                const dateA = new Date(eventsByMonth[a][0].date);
                const dateB = new Date(eventsByMonth[b][0].date);
                return dateA - dateB;
            });

            let html = '';
            monthOrder.forEach(month => {
                if(eventsByMonth[month]) {
                    html += `<div class="month-section">
                        <h3 class="text-2xl font-bold text-gray-700 mb-4">${month}</h3>
                        <div class="space-y-3">
                        ${eventsByMonth[month].map(event => {
                            const rawType = (event.type || '').toLowerCase();
                            const type = calendarTypeMap[rawType] || rawType;
                            let bgColor = 'bg-gray-100';
                            if (type === 'neradni') bgColor = 'bg-red-200 border border-red-300';
                            else if (type === 'događaj') bgColor = 'bg-yellow-200 border border-yellow-300';
                            else if (type === 'raspust') bgColor = 'bg-blue-200 border border-blue-300';
                            else if (type === 'nenastavni') bgColor = 'bg-green-200 border border-green-300';
                            return `<div class="flex items-center p-3 rounded-lg ${bgColor}">
                                <div class="w-24 font-semibold text-gray-700">${event.date}</div>
                                <div class="flex-1 text-gray-800">${event[`title_${currentLang}`]}</div>
                            </div>`;
                        }).join('')}
                        </div>
                    </div>`;
                }
            });
            container.innerHTML = html;

        } catch (error) {
            console.error("Error fetching calendar data:", error);
            container.innerHTML = `<div class="text-red-500 p-4 border border-red-200 rounded-md bg-red-50"><strong>Greška pri učitavanju kalendara.</strong><p class="text-sm mt-2">${error.message}</p></div>`;
        }
    }

    async function fetchMarqueeText() {
        const marqueeEl = document.querySelector('.marquee-content');
        try {
            const response = await fetch(marqueeSheetUrl, { cache: 'no-cache' });
            if (!response.ok) throw new Error('Network response was not ok');
            const text = await response.text();
            const data = parseCSV(text);
            validateData(data, ['content_bs', 'content_en', 'content_de'], 'Obavijesti');
            const messages = data.map(row => row[`content_${currentLang}`]);
            marqueeEl.textContent = messages.join(' || ');
        } catch(error) {
            console.error("Error fetching marquee text:", error);
            const fallbackKey = `marqueeText`;
            if (translations[currentLang] && translations[currentLang][fallbackKey]) {
                marqueeEl.textContent = translations[currentLang][fallbackKey];
            } else {
                 marqueeEl.textContent = translations['bs'].marqueeText; // Ultimate fallback
            }
        }
    }
    
    // --- Section visibility logic ---
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault(); 
            
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);

            if (!targetElement) return;

            if (targetId === 'trips-section' || targetId === 'calendar-section') {
                targetElement.classList.remove('hidden');
            }
            
            targetElement.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        });
    });

    document.getElementById('printBtn').addEventListener('click', () => {
        window.print();
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const scheduleElement = document.getElementById('schedule-to-print');
        const gradeText = document.getElementById('schedule-print-header').textContent;

        html2canvas(scheduleElement, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'pt',
                format: [canvas.width, canvas.height]
            });
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`${gradeText}.pdf`);
        });
    });
    
    // --- Initial Setup ---
    const teacherModal = document.getElementById('teacher-modal');
    const teacherOverlay = document.getElementById('teacher-modal-overlay');
    const teacherCloseBtn = document.getElementById('modal-close');
    const closeTeacherModal = () => {
        teacherModal.classList.remove('active');
        teacherOverlay.classList.remove('active');
    };
    teacherCloseBtn.addEventListener('click', closeTeacherModal);
    teacherOverlay.addEventListener('click', closeTeacherModal);
    
    setupTeacherSearch();
    setLanguage(currentLang);
});
</script>
</body>
</html>